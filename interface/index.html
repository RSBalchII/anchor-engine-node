<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Anchor Context Console</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --text: #e2e8f0;
            --accent: #38bdf8;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: system-ui;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            gap: 20px;
            box-sizing: border-box;
        }

        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border-radius: 12px;
            border: 1px solid #334155;
            padding: 20px;
        }

        input,
        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #000;
            color: #fff;
            box-sizing: border-box;
        }

        button {
            background: var(--accent);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        button:hover {
            opacity: 0.9;
        }

        textarea {
            flex: 1;
            background: #000;
            color: #a5f3fc;
            border: none;
            padding: 15px;
            font-family: monospace;
            resize: none;
            outline: none;
            border-radius: 8px;
        }

        .slider-group {
            background: var(--panel);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div>
            <label>ðŸ”Ž Search Memory</label>
            <input type="text" id="query" placeholder="Type keyword..." onkeyup="if(event.key==='Enter') search()">
        </div>
        <div class="slider-group">
            <label>Volume: <span id="vol-val">5000</span> chars</label>
            <input type="range" id="vol" min="1000" max="50000" step="1000" value="5000"
                oninput="document.getElementById('vol-val').innerText=this.value">
        </div>
        <button onclick="search()">Fetch Context</button>
        <button onclick="copy()" style="background: #334155; color: #fff; border: 1px solid #475569">ðŸ“‹ Copy to
            Clipboard</button>
        <button onclick="downloadBackup()" style="background: #10b981; color: white; margin-top: 10px; border: 1px solid #059669">
            ðŸ’¾ Eject Memory (Backup)
        </button>
    </div>
    <div class="main">
        <textarea id="output" readonly placeholder="Context results will appear here..."></textarea>
    </div>
    <script>
        async function search() {
            const query = document.getElementById('query').value;
            const limit = document.getElementById('vol').value;
            const out = document.getElementById('output');
            if (!query) return;
            out.value = "Searching...";
            try {
                const res = await fetch('http://localhost:3000/v1/memory/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query, max_chars: parseInt(limit) })
                });
                const data = await res.json();
                out.value = data.context || "No results.";

                // Send API response to log viewer for debugging
                const logChannel = new BroadcastChannel('sovereign-logs');
                logChannel.postMessage({
                    source: 'Context Console',
                    time: new Date().toISOString(),
                    type: 'info',
                    msg: `Search query: ${query}, Results: ${data.context ? data.context.length : 0} chars`
                });
            } catch (e) {
                out.value = "Error: " + e;

                // Send error to log viewer for debugging
                const logChannel = new BroadcastChannel('sovereign-logs');
                logChannel.postMessage({
                    source: 'Context Console',
                    time: new Date().toISOString(),
                    type: 'error',
                    msg: `Search error: ${e.message}`
                });
            }
        }
        function copy() {
            const el = document.getElementById('output');
            el.select();
            document.execCommand('copy');
        }

        async function downloadBackup() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "â³ Exporting...";

            try {
                const res = await fetch('http://localhost:3000/v1/backup');
                if (!res.ok) throw new Error("Backup failed");

                // Convert response to blob and trigger download
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // The server provides the filename in headers, but we can default
                a.download = `cozo_memory_snapshot_${new Date().toISOString().slice(0,10)}.yaml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                btn.innerText = "âœ… Exported!";
                setTimeout(() => btn.innerText = originalText, 2000);

            } catch (e) {
                alert("Export Error: " + e.message);
                btn.innerText = "âŒ Failed";
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }
    </script>
</body>

</html>