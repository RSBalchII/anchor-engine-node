services:
  chimaera-dev:
    # Build the image from the Dockerfile in the current directory
    build:
      context: .
    # Keep the container running and allow for interactive sessions
    tty: true
    stdin_open: true
    volumes:
      # Mount the entire local project directory to /app in the container
      # This means changes you make on your host machine are instantly reflected in the container
      - .:/app
      # Mount Ollama's model directory from the host to /models in the container
      # Using Ollama's default model storage location on Linux
      - ~/.ollama/models:/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    ports:
      - "8000:8000"
    depends_on:
      - neo4j
      - archivist
      - utcp-registry
    env_file:
      - .env
    environment:
      - OLLAMA_MODEL_LOAD_MODE=full
      - OLLAMA_NUM_GPU_LAYERS=999
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--log-level", "debug"]
    extra_hosts:
      - "model-runner.docker.internal:host-gateway"
      - "host.docker.internal:host-gateway"
    networks:
      - main_net

  neo4j:
    image: neo4j:latest
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
    environment:
      - NEO4J_AUTH=neo4j/password # Change this to a strong password in production
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main_net

  redis:
    image: redis/redis-stack-server:latest
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - main_net

  distiller:
    build:
      context: .
      dockerfile: ./dockerfiles/python-fastapi/Dockerfile
    volumes:
      - .:/app
    command: ["uvicorn", "ece.agents.tier3.distiller.distiller_agent:app", "--host", "0.0.0.0", "--port", "8001", "--reload"]
    ports:
      - "8001:8001"
    depends_on:
      - utcp-registry
    networks:
      - main_net

  injector:
    build:
      context: .
      dockerfile: ./dockerfiles/python-fastapi/Dockerfile
    volumes:
      - .:/app
    command: ["uvicorn", "ece.agents.tier3.injector.injector_app:app", "--host", "0.0.0.0", "--port", "8004", "--reload"]
    ports:
      - "8004:8004"
    depends_on:
      neo4j:
        condition: service_healthy
      utcp-registry:
        condition: service_started
    networks:
      - main_net

  archivist:
    build:
      context: .
    command: ["uvicorn", "ece.agents.tier3.archivist.archivist_agent:app", "--host", "0.0.0.0", "--port", "8003", "--reload"]
    volumes:
      - .:/app
    ports:
      - "8003:8003"
    depends_on:
      neo4j:
        condition: service_healthy
      redis:
        condition: service_started
      distiller:
        condition: service_started
      injector:
        condition: service_started
      qlearning:
        condition: service_started
      utcp-registry:
        condition: service_started
      filesystem-agent:
        condition: service_started
      websearch-agent:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8003/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main_net

  qlearning:
    build:
      context: .
    command: ["uvicorn", "ece.agents.tier3.qlearning.qlearning_app:app", "--host", "0.0.0.0", "--port", "8002", "--reload"]
    volumes:
      - .:/app
    ports:
      - "8002:8002"
    depends_on:
      neo4j:
        condition: service_healthy
      utcp-registry:
        condition: service_started
    networks:
      - main_net

  utcp-registry:
    build:
      context: .
      dockerfile: ./dockerfiles/python-fastapi/Dockerfile
    command: ["python", "-m", "utcp_registry.main", "--host", "0.0.0.0", "--port", "8005"]
    volumes:
      - .:/app
    ports:
      - "8005:8005"
    networks:
      - main_net

  filesystem-agent:
    build:
      context: .
      dockerfile: ./dockerfiles/python-fastapi/Dockerfile
    command: ["uvicorn", "ece.agents.tier2.filesystem_agent:app", "--host", "0.0.0.0", "--port", "8006", "--reload"]
    volumes:
      - .:/app
    ports:
      - "8006:8006"
    depends_on:
      - utcp-registry
    networks:
      - main_net

  websearch-agent:
    build:
      context: .
      dockerfile: ./dockerfiles/python-fastapi/Dockerfile
    command: ["uvicorn", "ece.agents.tier2.web_search_app:app", "--host", "0.0.0.0", "--port", "8007", "--reload"]
    volumes:
      - .:/app
    ports:
      - "8007:8007"
    depends_on:
      - utcp-registry
    networks:
      - main_net
    environment:
      - TAVILY_API_KEY=${TAVILY_API_KEY}

volumes:
  neo4j_data:
  redis_data:

networks:
  main_net:
    driver: bridge
