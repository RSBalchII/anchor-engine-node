<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sovereign Neural Shell</title>
    <style>
        :root {
            --bg: #0c0c0c;
            --term: #00ff00;
            --dim: #003300;
            --warn: #ffcc00;
            --err: #ff4444;
        }

        body {
            background: var(--bg);
            color: var(--term);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #terminal-output {
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 20px;
            border: 1px solid var(--dim);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px var(--dim) inset;
        }

        .line {
            margin-bottom: 5px;
        }

        .user-cmd {
            color: #fff;
            font-weight: bold;
        }

        .system-out {
            color: #ccc;
        }

        .error {
            color: var(--err);
        }

        .info {
            color: var(--warn);
        }

        #input-area {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #111;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        #cmd-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: inherit;
            font-size: 1.1em;
            outline: none;
        }

        #status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            transition: background 0.3s;
        }

        #status-light.on {
            background: var(--term);
            box-shadow: 0 0 10px var(--term);
        }

        #status-light.busy {
            background: var(--warn);
        }
    </style>
</head>

<body>
    <div id="terminal-output">
        <div class="line info">Welcome to the Neural Shell v1.0</div>
        <div class="line info">Bridge: http://localhost:8080 | Protocol: /v1/shell/exec</div>
        <div class="line">--------------------------------------------------</div>
    </div>

    <div id="input-area">
        <div id="status-light" title="Bridge Status"></div>
        <span style="color: var(--term); margin-right: 5px;">$</span>
        <input type="text" id="cmd-input" placeholder="Enter shell command (e.g. 'dir', 'whoami')..." autofocus>
    </div>

    <script>
        const DOM = {
            out: document.getElementById('terminal-output'),
            in: document.getElementById('cmd-input'),
            status: document.getElementById('status-light')
        };

        const BRIDGE_URL = "http://localhost:8080";
        const TOKEN = "sovereign-secret"; // Hardcoded for local dev

        function log(msg, type = 'system-out') {
            const div = document.createElement('div');
            div.className = `line ${type}`;
            div.textContent = msg;
            DOM.out.appendChild(div);
            DOM.out.scrollTop = DOM.out.scrollHeight;
        }

        async function checkPulse() {
            try {
                const res = await fetch(`${BRIDGE_URL}/health`);
                if (res.ok) DOM.status.classList.add('on');
                else DOM.status.classList.remove('on');
            } catch { DOM.status.classList.remove('on'); }
        }

        async function execute(cmd) {
            DOM.status.classList.add('busy');
            log(`$ ${cmd}`, 'user-cmd');

            try {
                const res = await fetch(`${BRIDGE_URL}/v1/shell/exec`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({ cmd })
                });

                const data = await res.json();

                if (data.stdout) log(data.stdout, 'system-out');
                if (data.stderr) log(data.stderr, 'error');
                if (data.error) log(`Bridge Error: ${data.error}`, 'error');
                if (data.code !== 0 && !data.error && !data.stderr) log(`Process exited with code ${data.code}`, 'info');

            } catch (e) {
                log(`Network Error: ${e.message}`, 'error');
            } finally {
                DOM.status.classList.remove('busy');
            }
        }

        DOM.in.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const raw = DOM.in.value.trim();
                if (!raw) return;

                // ðŸ§  Neural Mode: Intercept '?'
                if (raw.startsWith('?')) {
                    const query = raw.substring(1).trim();
                    if (query) {
                        log(`ðŸ§  Thinking: "${query}"...`, 'info');
                        DOM.in.value = ''; // Clear input during thinking
                        DOM.in.disabled = true;

                        const cmd = await askBrain(query);

                        DOM.in.disabled = false;
                        DOM.in.focus();

                        if (cmd) {
                            // Typer effect for cool factor
                            await typeEffect(cmd);
                        }
                    }
                    return;
                }

                // Standard Execution
                execute(raw);
                DOM.in.value = '';
            }
        });

        // ðŸ§  The "Brain" Connection
        async function askBrain(query) {
            DOM.status.classList.add('busy');
            try {
                // Use the new shell/exec endpoint which handles NL->Command conversion
                const res = await fetch(`${BRIDGE_URL}/v1/shell/exec`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                    body: JSON.stringify({
                        prompt: query  // Send natural language as prompt
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`${res.status} ${res.statusText} - ${errText || "Check Bridge/Console connection"}`);
                }

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                // The endpoint returns {command, explanation}
                return data.command || data;

            } catch (e) {
                log(`Brain Error: ${e.message}`, 'error');
                log(`(Ensure tools/model-server-chat.html is open with Ghost Engine loaded)`, 'info');
                return null;
            } finally {
                DOM.status.classList.remove('busy');
            }
        }

        async function typeEffect(text) {
            DOM.in.value = '';
            for (let i = 0; i < text.length; i++) {
                DOM.in.value += text[i];
                await new Promise(r => setTimeout(r, 10)); // 10ms delay per char
            }
        }

        // Init
        setInterval(checkPulse, 2000);
        checkPulse();
        DOM.in.focus();
    </script>
</body>

</html>