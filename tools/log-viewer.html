<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Anchor Core System Logs</title>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #toolbar {
            background-color: #111;
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #333;
            color: #fff;
            border: 1px solid #444;
            cursor: pointer;
            padding: 5px 10px;
        }

        button:hover {
            background: #444;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .panel-header {
            background: #1a1a1a;
            padding: 5px 10px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            white-space: pre-wrap;
            font-size: 12px;
        }

        .log-line {
            padding: 2px 0;
            border-bottom: 1px solid #111;
            word-break: break-all;
        }

        .log-line:hover {
            background-color: #111;
        }

        .info {
            color: #88ccff;
        }

        .warning {
            color: #ffcc00;
        }

        .error {
            color: #ff4444;
            font-weight: bold;
        }

        .debug {
            color: #888;
        }

        .success {
            color: #00ff00;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <span style="color: #88ccff; font-weight: bold;">Anchor Core Log Stream</span>
        <span id="connection-status" style="color: #888; margin-left: 10px;">‚óè Listening...</span>
        <div style="flex: 1;"></div>
        <button id="copy-all-btn" title="Copy all logs to clipboard">üìã Copy All</button>
        <button id="retry-logs-btn" title="Retry fetching backend logs">Retry Backend Logs</button>
        <button id="clear-btn">Clear All</button>
    </div>

    <div id="main-container">
        <!-- Single Combined Log Panel -->
        <div class="panel">
            <div class="panel-header">
                <span>All System Logs</span>
            </div>
            <div id="combined-logs" class="log-container"></div>
        </div>
    </div>

    <script>
        const combinedContainer = document.getElementById('combined-logs');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-all-btn');
        const statusIndicator = document.getElementById('connection-status');

        copyBtn.onclick = () => {
            const allText = combinedContainer.innerText;

            navigator.clipboard.writeText(allText).then(() => {
                const original = copyBtn.innerHTML;
                copyBtn.innerHTML = "‚úÖ Copied!";
                setTimeout(() => copyBtn.innerHTML = original, 2000);
            }).catch(e => alert("Copy failed: " + e));
        };

        const logChannel = new BroadcastChannel('sovereign-logs');
        const codaChannel = new BroadcastChannel('coda_logs');
        // Simple de-duplication for server polling
        const serverLogSet = new Set();

        function markActive() {
            statusIndicator.style.color = '#0f0';
            statusIndicator.innerText = '‚óè Active';
            setTimeout(() => {
                statusIndicator.style.color = '#888';
                statusIndicator.innerText = '‚óè Listening...';
            }, 2000);
        }

        logChannel.onmessage = (event) => {
            markActive();
            const data = event.data;

            if (data.source === 'system') {
                appendLog(combinedContainer, `[${data.time}] [${data.type}] ${data.msg}`, data.type);
            } else if (data.source === 'chat') {
                appendLog(combinedContainer, `[${data.time}] ${data.role}: ${data.text}`, 'info');
            }
        };

        // Mission Control channel (coda_logs) - short JSON messages
        codaChannel.onmessage = (event) => {
            markActive();
            const data = event.data;
            try {
                // Known sources: 'Sovereign-Console' | 'Sovereign-Chat' | 'Sovereign-DB' | 'Sovereign-Embed'
                if (data.source === 'Sovereign-Console') {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] [SOVEREIGN] ${data.message}`, data.type || 'info');
                } else if (data.source === 'Sovereign-Chat') {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] ${data.role || 'assistant'}: ${data.message}`, 'info');
                } else if (data.source === 'Sovereign-DB') {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] [DB] ${data.message}`, data.type || 'info');
                } else if (data.source === 'Sovereign-Embed' || data.source === 'WebGPU-Embed') {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] [EMBED] ${data.message}`, 'debug');
                } else if (data.source === 'WebGPU-Chat') {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] ${data.role || 'assistant'}: ${data.message}`, 'info');
                } else {
                    appendLog(combinedContainer, `[${new Date().toLocaleTimeString()}] ${JSON.stringify(data)}`, 'debug');
                }
            } catch (e) {
                appendLog(combinedContainer, `[coda_logs parsing error] ${e.message}`, 'error');
            }
        };

        // Poll backend server logs every 2s with graceful 404 handling and retry
        let pollIntervalId = null;
        let serverLogsErrorShown = false;

        async function pollServerLogs() {
            try {
                // Use the new logs endpoint
                const resp = await fetch('http://localhost:8000/logs/recent');

                if (resp.status === 404) {
                    if (!serverLogsErrorShown) {
                        appendLog(combinedContainer, `[ECE-Core] Logs endpoint returned 404. Is the backend running?`, 'warning');
                        statusIndicator.style.color = '#ffcc00';
                        statusIndicator.innerText = '‚óè Backend logs unavailable';
                        serverLogsErrorShown = true;
                    }
                    // Stop polling to avoid tight 404 loops
                    if (pollIntervalId) {
                        clearInterval(pollIntervalId);
                        pollIntervalId = null;
                    }
                    return;
                }

                if (!resp.ok) {
                    appendLog(combinedContainer, `[ECE-Core] Poll error: HTTP ${resp.status}`, 'error');
                    return;
                }

                const payload = await resp.json();
                if (payload && Array.isArray(payload.logs)) {
                    for (const logEntry of payload.logs) {
                        const line = `[${new Date(logEntry.timestamp).toLocaleTimeString()}] [${logEntry.source}] ${logEntry.message}`;
                        if (!serverLogSet.has(line)) {
                            serverLogSet.add(line);
                            appendLog(combinedContainer, `[ECE-Core] ${line}`, logEntry.type || 'info');
                        }
                    }
                    // Prevent unbounded growth
                    if (serverLogSet.size > 500) {
                        serverLogSet.clear();
                    }
                }
            } catch (e) {
                if (!serverLogsErrorShown) {
                    appendLog(combinedContainer, `[ECE-Core] Poll error: ${e.message}`, 'error');
                    statusIndicator.style.color = '#ff4444';
                    statusIndicator.innerText = '‚óè Poll error';
                    serverLogsErrorShown = true;
                }
            }
        }

        function startPolling() {
            if (pollIntervalId) return;
            serverLogsErrorShown = false;
            statusIndicator.style.color = '#0f0';
            statusIndicator.innerText = '‚óè Active';
            pollIntervalId = setInterval(pollServerLogs, 2000);
            pollServerLogs();
        }

        function stopPolling() {
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
        }

        // Start polling initially
        startPolling();

        // Retry button
        document.getElementById('retry-logs-btn').addEventListener('click', () => {
            appendLog(combinedContainer, '[ECE-Core] Manual retry requested', 'info');
            statusIndicator.style.color = '#88ccff';
            statusIndicator.innerText = '‚óè Retrying...';
            startPolling();
        });

        function appendLog(container, text, type) {
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerHTML = colorize(text, type);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function colorize(line, type) {
            if (type === 'error' || line.includes('ERROR') || line.includes('‚ùå')) return `<span class="error">${line}</span>`;
            if (type === 'warn' || line.includes('WARNING')) return `<span class="warning">${line}</span>`;
            if (type === 'success' || line.includes('SUCCESS') || line.includes('‚úÖ')) return `<span class="success">${line}</span>`;
            if (type === 'info' || line.includes('INFO')) return `<span class="info">${line}</span>`;
            return `<span class="debug">${line}</span>`;
        }

        clearBtn.onclick = () => {
            combinedContainer.innerHTML = '';
        };
    </script>
</body>

</html>