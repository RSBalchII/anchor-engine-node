<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Coda Console</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: #0f0f11;
            color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        /* --- Resizable Split Layout --- */
        #container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            /* Default width */
            min-width: 200px;
            max-width: 80%;
            background: #151517;
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            transition: width 0.1s ease;
        }

        /* Resize Handle */
        #resizer {
            width: 5px;
            cursor: col-resize;
            background: #333;
            transition: background 0.2s;
            z-index: 10;
        }

        #resizer:hover,
        #resizer.resizing {
            background: #00ff88;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            position: relative;
            min-width: 0;
        }

        /* --- Collapsible Details --- */
        details {
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        summary {
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            background: #252526;
            list-style: none;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '‚ñº';
            float: right;
            font-size: 0.8em;
            transition: transform 0.2s;
        }

        details[open] summary::after {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* --- Chat Box --- */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        #chat-box::-webkit-scrollbar {
            width: 8px;
        }

        #chat-box::-webkit-scrollbar-track {
            background: #333;
        }

        #chat-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .msg {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            background: #333;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user {
            background: #005f3b;
            /* Root Green-ish */
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .assistant {
            background: #2d2d2d;
            border-left: 3px solid #00ff88;
        }

        .msg details {
            margin-top: 10px;
            font-size: 0.85rem;
            opacity: 0.7;
            border: none;
        }

        .msg pre {
            background: #151515;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        h3 {
            margin: 0 0 10px 0;
        }

        #status-text {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }

        #progress-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        #progress {
            height: 100%;
            background: #00ff88;
            width: 0%;
            transition: width 0.2s;
        }

        #status-log {
            flex: 1;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            margin-top: 10px;
            padding: 8px;
            background: #0f0f0f;
            border-radius: 4px;
            border: 1px solid #333;
        }

        #status-log div {
            margin: 2px 0;
            padding: 2px 0;
        }

        .info {
            color: #888;
        }

        .warn {
            color: #ffc107;
        }

        .error {
            color: #ff4444;
        }

        .success {
            color: #00ff88;
        }

        #input-area {
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            height: 60px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 10px;
            border-radius: 4px;
            resize: vertical;
            font-family: 'Segoe UI', sans-serif;
        }

        textarea:focus {
            outline: none;
            border-color: #00ff88;
        }

        button {
            padding: 8px 20px;
            background: #2d2d2d;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-end;
            transition: all 0.2s;
        }

        button:hover {
            border-color: #00ff88;
            color: #00ff88;
        }

        button:disabled {
            background: #222;
            border-color: #333;
            color: #555;
            cursor: not-allowed;
        }

        .streaming {
            border-right: 2px solid #00ff88;
            animation: blink 0.7s infinite;
        }

        @keyframes blink {
            50% {
                border-color: transparent;
            }
        }

        /* --- Drag & Drop --- */
        #input-area.drag-active {
            border: 2px dashed #00ff88;
            background: #1a1a1a;
        }

        #image-preview-container {
            display: none; /* Hidden by default */
            margin-bottom: 5px;
            padding: 8px;
            background: #252526;
            border-radius: 6px;
            border: 1px solid #444;
            position: relative;
            width: fit-content;
        }

        #image-preview-container .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        #image-preview-container img {
            max-height: 100px;
            max-width: 200px;
            border-radius: 4px;
            display: block;
            object-fit: contain;
        }

        #image-preview-container div {
            font-size: small;
            margin-top: 5px;
        }

        #image-preview-container button {
            margin-top: 5px;
            padding: 4px 8px;
            background: #a43131;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        #input-area.drag-active {
            border: 2px dashed #00ff88;
            background: #1a1a1a;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="sidebar">
            <div
                style="padding: 10px; font-weight: bold; font-size: 16px; border-bottom: 1px solid #444; color: #00ff88;">
                ‚ö° ROOT CODA
            </div>
            <small id="status-text" style="padding: 0 10px;">Initializing...</small>
            <div id="progress-bar" style="margin: 8px 10px 15px 10px;">
                <div id="progress"></div>
            </div>

            <!-- COLLAPSIBLE: Model Selection -->
            <details open>
                <summary>Model Selection</summary>
                <div class="panel-content">
                    <label for="hw-profile"
                        style="display:block; font-size: 11px; color: #ccc; margin-bottom: 4px;">Hardware
                        Profile:</label>
                    <select id="hw-profile" class="form-control"
                        style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555; margin-bottom: 10px;">
                        <option value="lite">üîã Lite (Mobile / Snapdragon) - 2k Context</option>
                        <option value="mid" selected>üíª Mid (8GB VRAM) - 4k Context</option>
                        <option value="high">üöÄ High (16GB VRAM) - 16k Context</option>
                        <option value="ultra">‚ö° Ultra (24GB+ VRAM) - 32k Context</option>
                    </select>
                    <select id="model-select" disabled
                        style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555;">
                        <option value="" disabled>-- Select a Model --</option>

                        <optgroup label="‚ú® SOTA (Latest)">
                            <option value="mlc-ai/DeepSeek-R1-Distill-Qwen-7B-q4f16_1-MLC">DeepSeek R1 (7B Distill) [Verified]</option>
                            <option value="mlc-ai/Qwen3-4B-q4f16_1-MLC">Qwen 3 4B (Base) [Verified]</option>
                            <option value="mlc-ai/Qwen3-8B-q4f16_1-MLC">Qwen 3 8B (Base) [Verified]</option>
                            <option value="mlc-ai/Qwen2.5-7B-Instruct-q4f16_1-MLC" selected>Qwen 2.5 7B (Instruct) [Verified]</option>
                            <option value="mlc-ai/Phi-3.5-mini-instruct-q4f16_1-MLC">Phi 3.5 Mini (3.8B)</option>
                        </optgroup>

                        <optgroup label="üëÅÔ∏è Vision Models">
                            <option value="mlc-ai/Phi-3.5-vision-instruct-q4f16_1-MLC">Phi 3.5 Vision (4.2B) [Multimodal]</option>
                        </optgroup>

                        <optgroup label="üåü 14B Models">
                            <option value="mlc-ai/Qwen2.5-14B-Instruct-q4f16_1-MLC">Qwen 2.5 14B (Instruct)</option>
                            <option value="mlc-ai/DeepSeek-R1-Distill-Qwen-14B-q4f16_1-MLC">DeepSeek R1 (14B Distill)</option>
                        </optgroup>

                        <optgroup label="üöÄ High Performance (Small)">
                            <option value="mlc-ai/Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen 2.5 1.5B (Instruct) [Lite Choice]</option>
                            <option value="mlc-ai/SmolLM2-1.7B-Instruct-q4f16_1-MLC">SmolLM2 1.7B (Instruct)</option>
                            <option value="mlc-ai/Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B (Instruct)</option>
                            <option value="mlc-ai/Qwen3-0.6B-q4f16_1-MLC">Qwen 3 0.6B (Base) [Micro]</option>
                        </optgroup>

                        <optgroup label="üß™ Experimental / Other">
                            <option value="mlc-ai/Llama-3.2-3B-Instruct-q4f16_1-MLC">Llama 3.2 3B</option>
                            <option value="mlc-ai/gemma-2-2b-it-q4f16_1-MLC">Gemma 2 2B</option>
                            <option value="mlc-ai/TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC">TinyLlama 1.1B</option>
                        </optgroup>

                        <option value="custom">-- Custom --</option>
                    </select>
                    <input id="custom-model-input" type="text" placeholder="Custom model ID"
                        style="width: 100%; padding: 5px; font-size: 11px;" disabled />
                    <button id="load-model-btn" disabled
                        style="width: 100%; padding: 6px; margin-top:5px; font-size: 11px;">Load Model</button>
                    <div style="font-size: 9px; color: #888; margin-top: 5px;">
                        * Models marked with * may require checking availability in MLC-AI repository
                    </div>
                </div>
            </details>

            <!-- COLLAPSIBLE: Controls -->
            <details>
                <summary>System Controls</summary>
                <div class="panel-content">
                    <div
                        style="background: #222; padding: 4px; margin-bottom: 4px; border: 1px solid #444; border-radius: 4px;">
                        <input type="checkbox" id="enable-bridge-toggle" onchange="toggleBridge(this.checked)">
                        <label for="enable-bridge-toggle" style="font-size: 11px; cursor: pointer;">Enable Wave Bridge
                            (ws:8080)</label>
                        <div id="bridge-status" style="font-size: 10px; color: #666; margin-left: 20px;">Disconnected
                        </div>
                    </div>
                    <div
                        style="background: #222; padding: 4px; margin-bottom: 4px; border: 1px solid #444; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autosave-toggle" checked onchange="toggleAutoSave(this.checked)">
                        <label for="autosave-toggle" style="font-size: 11px; cursor: pointer;">üíæ Auto-Save Memories</label>
                    </div>
                    <button id="clear-cache-btn"
                        style="width: 100%; padding: 6px; background: #a43131; border:none; margin-top:5px; font-size: 11px;">‚ö†Ô∏è
                        Delete Model Cache</button>
                    <button id="debug-gpu-btn"
                        style="width: 100%; padding: 6px; background: #555; border:none; margin-top: 5px; font-size: 11px;">‚ùì
                        Debug GPU</button>
                    <button id="force-unlock-btn"
                        style="width: 100%; padding: 6px; background: #da3633; border:none; margin-top: 5px; font-size: 11px; color: white;">üîì
                        Force Unlock GPU</button>
                </div>
            </details>

            <!-- COLLAPSIBLE: Logs -->
            <details open style="flex: 1; display: flex; flex-direction: column;">
                <summary>System Logs</summary>
                <div class="panel-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <button id="copy-logs-btn" style="width: 100%; padding: 4px; background: #333; font-size: 10px;">üìã
                        Copy Logs</button>
                    <div id="status-log"></div>
                </div>
            </details>
        </div>

        <div id="resizer"></div>

        <div id="main">
            <!-- Split view for Chat and Context -->
            <div style="flex: 1; display: flex; height: 100%; overflow: hidden;">
                <!-- Chat Column -->
                <div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #333;">
                    <div style="padding: 10px; background: #252526; font-weight: bold; border-bottom: 1px solid #333;">
                        üí¨ Chat Stream</div>
                    <div id="chat-box"></div>
                    
                    <!-- Input Area with Drag & Drop -->
                    <div id="input-container" style="border-top: 1px solid #333; padding: 10px; display: flex; flex-direction: column;">
                        <div id="image-preview-container"></div>
                        <div id="input-area" style="display: flex; gap: 10px; padding: 5px; border: 2px dashed transparent; border-radius: 6px; transition: all 0.2s;">
                            <textarea id="input" disabled placeholder="Type or Drag & Drop Image..."></textarea>
                            <button id="send-btn" disabled>Send</button>
                        </div>
                    </div>
                </div>

                <!-- Context Column -->
                <div style="width: 40%; display: flex; flex-direction: column; background: #151515;">
                    <div style="padding: 10px; background: #252526; font-weight: bold; border-bottom: 1px solid #333;">
                        üß† Root Memory</div>
                    <div id="context-box"
                        style="flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; color: #aaa;">
                        <div style="text-align: center; margin-top: 50px; color: #555;">(Active retrievals will appear
                            here)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
        import { SovereignLogger, createStore, getWebGPUConfig, initCozo, GPUController } from './modules/sovereign.js';

        // Load hot reload functionality in development
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            import('./modules/gpu-hot-reloader.js').then(() => {
                console.log('üîÑ GPU Hot Reloader loaded for development');
            }).catch(err => {
                console.warn('‚ö†Ô∏è GPU Hot Reloader not available:', err);
            });
        }
        import { CozoDb } from './cozo_lib_wasm.js';
        import { loadAllFromIndexedDb, writeToIndexedDb } from './indexeddb.js';
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';
        import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
        import { VisionController } from './modules/vision.js';

        env.allowLocalModels = false;

        // --- ROOT KERNEL SETUP ---
        const logger = new SovereignLogger('Root-Console');

        const { state, subscribe } = createStore({
            status: "Initializing...",
            progress: 0,
            activeModel: null,
            autoSave: true
        });

        // --- UTILS: The Archivist ---
        async function saveTurn(role, content) {
            if (!state.autoSave || !window.db) return;
            try {
                const ts = Date.now();
                const id = 'msg_' + ts + '_' + role;

                // Write to Memory (Embedding null for Dreamer to fix later)
                const query = ":put memory { id: $id, timestamp: $ts, role: $role, content: $content, source: 'root_console', embedding: null }";
                await window.db.run(query, JSON.stringify({ id, ts, role, content }));
                ui.log(`üíæ Memory Saved (${role})`, "debug");
            } catch (e) {
                ui.log(`Save Failed: ${e.message}`, "error");
            }
        }

        // Expose toggle handler globally
        window.toggleAutoSave = (checked) => { 
            state.autoSave = checked; 
            ui.log(`Auto-Save: ${checked ? 'ON' : 'OFF'}`, 'info');
        };

        // Bridge legacy UI logging to Sovereign Logger
        const ui = {
            log: (msg, type = 'info') => {
                // Bridge to Kernel Logger
                if (type === 'debug') type = 'info';
                if (logger[type]) logger[type](msg); else logger.info(msg);

                // Update on-screen log
                const el = document.getElementById('status-log');
                if (el) {
                    const div = document.createElement('div');
                    div.className = type;
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    div.style.fontSize = '11px';
                    div.style.padding = '2px';
                    div.style.borderBottom = '1px solid #222';
                    el.insertBefore(div, el.firstChild);
                    if (el.children.length > 100) el.removeChild(el.lastChild);
                }
            },
            updateProgress: (pct, text) => {
                const bar = document.getElementById('progress');
                if (bar) bar.style.width = (pct * 100) + "%";
                if (text) {
                    const el = document.getElementById('status-text');
                    if (el) el.innerText = text;
                }
            },
            append: (role, text, meta = null) => {
                const box = document.getElementById('chat-box');
                const div = document.createElement('div');
                div.className = `msg ${role}`;
                div.innerHTML = text ? marked.parse(text) : "";

                if (meta && meta.trace && meta.trace.length > 0) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.textContent = 'üìã Reasoning Trace';
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(meta.trace, null, 2);
                    details.appendChild(summary);
                    details.appendChild(pre);
                    div.appendChild(details);
                }

                box.appendChild(div);
                box.scrollTop = box.scrollHeight;

                return {
                    div,
                    update: (newText, isMarkdown = true) => {
                        div.innerHTML = isMarkdown ? marked.parse(newText) : newText;
                        box.scrollTop = box.scrollHeight;
                    },
                    appendText: (chunk) => {
                        if (div.innerText.endsWith("...")) div.innerText = div.innerText.slice(0, -3);
                        div.innerText += chunk;
                        box.scrollTop = box.scrollHeight;
                    }
                };
            },
            appendContext: (title, details) => {
                const box = document.getElementById('context-box');
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #333';
                div.style.marginBottom = '10px';
                div.style.paddingBottom = '10px';

                const h4 = document.createElement('div');
                h4.style.fontWeight = 'bold';
                h4.style.color = '#00ff88';
                h4.style.marginBottom = '5px';
                h4.textContent = `[${new Date().toLocaleTimeString()}] ${title}`;

                const p = document.createElement('div');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = details;

                div.appendChild(h4);
                div.appendChild(p);
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        // --- GLOBAL STATE ---
        let db;
        let embedder;
        let engine;
        let contextManager;
        let selectedModelId = null;

        // VisionController will handle all image-related functionality

        // --- UTILS: Response Pattern Matcher ---
        class ResponsePattern {
            static match(response) {
                let data = response;
                if (typeof response === 'string') {
                    try {
                        const clean = response.replace(/```json/g, '').replace(/```/g, '').trim();
                        if (clean.startsWith('{')) data = JSON.parse(clean);
                    } catch (e) { }
                }
                if (data?.rows && Array.isArray(data.rows)) return { type: 'DB_RESULT', rows: data.rows, count: data.rows.length };
                if (data?.error || (typeof response === 'string' && response.toLowerCase().includes('error:'))) return { type: 'ERROR', error: data?.error || response };
                if (data?.ok === false && data?.message) return { type: 'ERROR', error: data.message };
                return { type: 'RAW_TEXT', text: typeof response === 'string' ? response : JSON.stringify(response) };
            }
        }

        // --- LOGIC: Context Manager (SFS) ---
        class ContextManager {
            constructor(engine, db) {
                this.engine = engine;
                this.db = db;
                this.maxIterations = 3;
            }

            // NEW: Pure retrieval logic (returns raw data objects)
            async findRelevantMemories(userText) {
                // 1. GENERATE QUERY VECTOR (Semantic)
                let vectorResults = [];
                if (embedder) {
                    try {
                        const output = await embedder(userText, { pooling: 'mean', normalize: true });
                        const queryVec = Array.from(output.data);
                        // Query: Find top 10 nearest neighbors
                        const vecQuery = `
                            ?[id, content, dist, timestamp] := *memory{id, content, embedding, timestamp},
                            !is_null(embedding),
                            dist = vec_l2(embedding, $vec)
                            :sort dist
                            :limit 10
                        `;
                        const res = await this.db.run(vecQuery, JSON.stringify({ vec: queryVec }));
                        const parsed = ResponsePattern.match(res);
                        if (parsed.rows) vectorResults = parsed.rows.map(r => ({ id: r[0], content: r[1], dist: r[2], ts: r[3], source: 'semantic' }));
                    } catch (e) { console.warn("Vector Search failed", e); }
                }

                // 2. GENERATE KEYWORD QUERY (Lexical)
                let keywordResults = [];
                const rawWords = userText.match(/[a-zA-Z0-9_\-]+/g) || [];
                const stopWords = new Set(['the', 'and', 'is', 'in', 'at', 'of', 'on', 'for', 'to', 'it', 'this', 'that', 'what', 'who', 'how', 'why', 'when', 'where', 'tell', 'me', 'about']);
                const keywords = rawWords.map(w => w.replace(/^[-_]+|[-_]+$/g, '')).filter(w => w.length > 3 && !stopWords.has(w.toLowerCase()));
                
                if (keywords.length > 0) {
                    const conditions = keywords.map(w => `regex_matches(content, '(?i)${w}')`).join(' or ');
                    const kwQuery = `?[id, content, timestamp] := *memory{id, content, timestamp}, ${conditions} :sort -timestamp :limit 10`;
                    try {
                        const res = await this.db.run(kwQuery, "{}");
                        const parsed = ResponsePattern.match(res);
                        if (parsed.rows) keywordResults = parsed.rows.map(r => ({ id: r[0], content: r[1], dist: 0, ts: r[2], source: 'lexical' }));
                    } catch (e) { console.warn(e); }
                }

                // 3. MERGE & DEDUPLICATE
                const combined = new Map();
                // Add Semantic first
                vectorResults.forEach(item => combined.set(item.content, item));
                // Add Lexical (only if unique)
                keywordResults.forEach(item => {
                    if (!combined.has(item.content)) combined.set(item.content, item);
                });
                
                // Return top 10 unique items
                return Array.from(combined.values()).slice(0, 10);
            }

            // EXISTING: Formats the data for the R1 Reasoning Loop
            async retrieveInitialContext(userText) {
                const topItems = await this.findRelevantMemories(userText);
                if (topItems.length === 0) return "";

                const paths = [];
                const clues = topItems.map((item, index) => {
                    const id = index + 1;
                    let title = "doc_" + id;
                    // Simple title extraction
                    if (item.content.length > 0) {
                        const safeTitle = item.content.substring(0, 30).replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '_').toLowerCase();
                        if (safeTitle.length > 3) title = safeTitle;
                    }
                    const path = `/knowledge/${item.source}/${title}`;
                    paths.push(path);

                    let snippet = item.content.substring(0, 300).replace(/\n/g, ' ');
                    if (item.content.length > 300) snippet += "...";

                    return `[CLUE #${id}] [Path: ${path}] [Source: ${item.source || 'unknown'}]\nSnippet: "${snippet}"`;
                });
                
                ui.log(`‚úÖ Hybrid Retrieval: ${topItems.length} active clues.`, "success");
                const treeMap = `[CURRENT REALITY MAP]\n` + paths.map(p => `- ${p}`).join('\n');
                return `${treeMap}\n\n[CONTEXT CLUES]\n${clues.join('\n\n')}`;
            }

            // ... (Keep buildVirtualPrompt and executeR1Loop exactly as they were in combined_text.txt source 1976-1996)
            buildVirtualPrompt(systemPrompt, retrievedMemories, chatHistory, userText) {
                const now = new Date().toLocaleString('en-US', { timeZoneName: 'short' });
                const physicsInstruction = `
### COGNITIVE PROTOCOL:
1. **TRUST THE CLUES:** You are operating in a "Sovereign" environment. The [CONTEXT CLUES] provided are the Ground Truth.
2. **MINIMIZE ENTROPY:** If a Clue contains the answer, OUTPUT IT DIRECTLY. Do not generate "filler".
3. **PATH OF LEAST ACTION:** The most efficient answer is the correct one.
`;
                return `### SYSTEM TIME\n${now}\n\n### BACKGROUND INFORMATION\n${retrievedMemories ? retrievedMemories : "No specific context available."} \n\n### CHAT HISTORY\n${chatHistory.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n')}\n\n### INSTRUCTION\n${systemPrompt}\n${physicsInstruction}\nBased on the Background Information above, answer the following question.\n\n### USER QUESTION\n${userText}`;
            }

            async executeR1Loop(userText, history) {
                let iteration = 0;
                let currentContext = await this.retrieveInitialContext(userText);
                if (currentContext) ui.appendContext("Reflex Retrieval", currentContext);
                while (iteration < this.maxIterations) {
                    iteration++;
                    const fullPrompt = this.buildVirtualPrompt(
                        "You are Root Coda, a Sovereign Agent.\nPROTOCOL: Trust clues. Answer directly. No refusals.",
                        currentContext,
                        history.slice(-5),
                        userText
                    );
                    ui.log(`üß† Reasoning (Iter ${iteration})...`, "info");
                    let reply = "";
                    try {
                        const response = await this.engine.chat.completions.create({
                            messages: [{ role: "user", content: fullPrompt }],
                            temperature: 0.1,
                            max_tokens: 100
                        });
                        reply = response.choices[0].message.content.trim();
                    } catch (genErr) {
                        const errMsg = genErr?.message || String(genErr);
                        if (errMsg.includes("disposed")) return { context: currentContext, finalAnswer: "‚ö†Ô∏è System Crash: GPU Driver lost." };
                        throw genErr;
                    }

                    if (!reply) reply = ""; 

                    if (reply.includes("NEED_CONTEXT:")) {
                        const searchTerm = reply.split("NEED_CONTEXT:")[1].trim();
                        ui.log(`ü§ñ Requested search: "${searchTerm}"`, "warn");
                        const extraData = await this.retrieveInitialContext(searchTerm);
                        if (extraData) {
                            currentContext += `\n--- Additional (${searchTerm}) ---\n${extraData}`;
                            ui.appendContext(`Requested: ${searchTerm}`, extraData);
                        }
                        continue;
                    }
                    return { context: currentContext, finalAnswer: reply };
                }
                return { context: currentContext, finalAnswer: null };
            }
        }

        // --- HANDLERS ---
        async function handleSend() {
            const input = document.getElementById('input');
            const text = input.value.trim();

            // Get image from VisionController
            const imageBase64 = vision ? vision.getImage() : null;

            // Allow sending if there is text OR an image
            if ((!text && !imageBase64) || !engine) return;

            input.value = "";
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            // Display Logic
            if (imageBase64) {
                ui.append("user", `![Uploaded Image](${imageBase64})\n\n${text}`);
            } else {
                ui.append("user", text);
            }

            if (state.autoSave) await saveTurn("user", text + (imageBase64 ? " [Image Attached]" : ""));

            try {
                // Construct Message Payload
                let messages = [];
                let context = "";

                // Wrap GPU-heavy ops in lock
                await GPUController.withLock("Root-Console-Chat", async () => {
                    // If Image: Bypass R1 Loop (Vision models typically don't do R1 reasoning yet or complex context mixing)
                    // We use a direct shot for now.
                    if (imageBase64) {
                         messages = [
                            { role: "system", content: "You are a helpful assistant. Analyze the user's image and text." },
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: text || "What is in this image?" },
                                    { type: "image_url", image_url: { url: imageBase64 } }
                                ]
                            }
                        ];
                        ui.log("üëÅÔ∏è Processing Visual Data...", "warn");
                    } else {
                        // Standard Text Path (R1 Loop)
                        const r1Result = await contextManager.executeR1Loop(text, []);
                        context = r1Result.context;
                        const finalAnswer = r1Result.finalAnswer;

                        if (finalAnswer && finalAnswer.includes("System Crash")) return ui.log("üõë Execution halted (GPU Crash).", "error");

                        ui.log("üß™ Synthesizing...", "warn");
                        const sysPrompt = `You are a helpful assistant with access to retrieved context. Use it to answer the user's question.\n\nCONTEXT:\n${context || "(No relevant context)"}`;
                        messages = [{ role: "system", content: sysPrompt }, { role: "user", content: text }];
                    }

                    const msgHandle = ui.append("assistant", "");

                    const stream = await engine.chat.completions.create({
                        messages: messages,
                        max_tokens: 1024,
                        temperature: 0.7,
                        stream: true
                    });

                    let fullAnswer = "";
                    for await (const chunk of stream) {
                        const delta = chunk.choices[0]?.delta?.content || "";
                        fullAnswer += delta;
                        msgHandle.update(fullAnswer);
                    }

                    // Cleanup - Clear the image from VisionController
                    if (imageBase64 && vision) {
                        vision.clear();
                    }

                    if (state.autoSave) await saveTurn("assistant", fullAnswer);
                    ui.log("‚úÖ Response generated.", "success");
                }); // End Lock

            } catch (e) {
                const msg = e.message || String(e) || "Unknown Error";
                ui.log(`Error: ${msg}`, "error");
                ui.append("assistant", `**Error:** ${msg}`);
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        async function loadModel() {
            const select = document.getElementById('model-select');
            const customInput = document.getElementById('custom-model-input');
            const modelInput = select.value === 'custom' ? customInput.value : select.value;
            if (!modelInput) return alert("Please select a model.");

            selectedModelId = modelInput.split('/').pop();
            document.getElementById('load-model-btn').disabled = true;

            try {
                // 0. THE BLOCKER (Model Load Lock) - Serialize model loading
                ui.log("‚è≥ Queueing for Model Load (Sequential)...", "info");

                await GPUController.withModelLoadLock("Root-Console-Init", async () => {
                    ui.log(`Initializing Engine (${selectedModelId})...`, "info");

                    // --- KERNEL: Hardware Config ---
                    const hwProfile = document.getElementById('hw-profile').value;
                    const gpuConfig = await getWebGPUConfig(hwProfile);

                    if (gpuConfig.isConstrained) {
                        ui.log(`‚ö†Ô∏è Clamping WebGPU buffer to ${Math.round(gpuConfig.maxBufferSize / 1024 / 1024)}MB`, "warn");
                    } else {
                        ui.log(`‚úÖ GPU Configured: ${Math.round(gpuConfig.maxBufferSize / 1024 / 1024)}MB Buffer`, "success");
                    }

                    // --- Config Generation ---
                    // (Simplified Logic for cleaner file)
                    const libBase = "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0_2_80/"; // Fixed URL
                    let modelLib = null;
                    const lowerId = selectedModelId.toLowerCase();
                    let qTag = "q4f16_1"; // Default

                    // Mapper
                    // SOTA / New
                    if (lowerId.includes('deepseek-r1') && lowerId.includes('7b')) modelLib = libBase + `Qwen2-7B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('deepseek-r1') && lowerId.includes('14b')) modelLib = libBase + `Qwen2.5-14B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen3-4b')) modelLib = libBase + `Qwen3-4B-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen3-8b')) modelLib = libBase + `Qwen3-8B-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen2.5-7b')) modelLib = libBase + `Qwen2-7B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen2.5-14b')) modelLib = libBase + `Qwen2.5-14B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('phi-3.5-mini')) modelLib = libBase + `Phi-3.5-mini-instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;

                    // Vision Models
                    else if (lowerId.includes('phi-3.5-vision')) modelLib = libBase + `Phi-3.5-vision-instruct-q4f16_1-ctx4k_cs2k-webgpu.wasm`;

                    // Small / Efficient
                    else if (lowerId.includes('qwen3-0.6b')) modelLib = libBase + `Qwen3-0.6B-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('llama-3.2-1b')) modelLib = libBase + `Llama-3.2-1B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen2.5-1.5b')) modelLib = libBase + `Qwen2-1.5B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('smollm2-1.7b')) modelLib = libBase + `SmolLM2-1.7B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('smollm2-360m')) modelLib = libBase + `SmolLM2-360M-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('tinyllama-1.1b')) modelLib = libBase + `TinyLlama-1.1B-Chat-v1.0-q4f16_1-ctx2k_cs1k-webgpu.wasm`;

                    // Fallbacks
                    else if (lowerId.includes('qwen2.5-1.5b')) modelLib = libBase + `Qwen2-1.5B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                    else if (lowerId.includes('qwen2.5-7b')) modelLib = libBase + `Qwen2-7B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;

                    if (!modelLib) modelLib = libBase + `Qwen2.5-3B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`; // Safe Fallback 3B

                    let appConfig = {
                        useIndexedDBCache: true,
                        model_list: [{
                            model: "https://huggingface.co/" + modelInput + "/resolve/main/",
                            model_id: selectedModelId,
                            model_lib: modelLib,
                            vram_required_MB: 2000,
                            low_resource_required: true,
                            buffer_size_required_bytes: gpuConfig.maxBufferSize,
                        }]
                    };

                    // Create the Worker
                    const worker = new Worker('./modules/llm-worker.js', { type: 'module' });

                    // Initialize Engine via Worker
                    engine = await CreateWebWorkerMLCEngine(
                        worker,
                        selectedModelId,
                        {
                            appConfig, // Passing the VRAM/Buffer limits we calculated
                            initProgressCallback: (rep) => ui.updateProgress(rep.progress, rep.text)
                        }
                    );
                }); // Uses the default 5-minute timeout for model loading

                ui.log("üéâ Root Console Online", "success");
                contextManager = new ContextManager(engine, db);
                document.getElementById('input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('input').focus();

            } catch (e) {
                const errorMsg = e.message || String(e);
                ui.log(`Load Failed: ${errorMsg}`, "error");
                // Provide suggestion for common model name issues
                if (errorMsg && errorMsg.includes("Network response was not ok")) {
                    ui.log(`üí° Hint: Model may not exist or be temporarily unavailable. Try another model.`, "warn");
                }
                document.getElementById('load-model-btn').disabled = false;
            }
        }

        let vision = null; // Global VisionController instance

        async function init() {
            try {
                ui.log("üöÄ Root Kernel Starting...", "info");

                // 1. CozoDB
                await initCozo('./cozo_lib_wasm_bg.wasm');
                // Recovery Logic
                try {
                    const [keys] = await loadAllFromIndexedDb('coda_memory', 'cozo_store', () => { });
                    if (keys.length > 0) {
                        db = await CozoDb.new_from_indexed_db('coda_memory', 'cozo_store', () => { });
                        window.db = db;
                        ui.log("‚úÖ Root Graph Connected (Persistent)", "success");
                    } else {
                        db = CozoDb.new();
                        window.db = db;
                        ui.log("‚úÖ Root Graph Created (Memory)", "info");
                    }
                } catch (e) {
                    db = CozoDb.new();
                    window.db = db;
                    ui.log("‚ö†Ô∏è Fallback to Memory Graph", "warn");
                }

                // 2. Embedder (Optional)
                ui.updateProgress(0.3, "Loading Embedder...");
                const embedderPromise = pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { device: 'wasm' });
                try {
                    embedder = await Promise.race([embedderPromise, new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 10000))]);
                    ui.log("‚úÖ Neural Embedder Ready", "success");
                } catch (e) { ui.log("‚ö†Ô∏è Embedder Skipped (Timeout)", "warn"); }

            } catch (e) {
                ui.log(`Init Error: ${e.message}`, "error");
            } finally {
                // Initialize VisionController
                vision = new VisionController();
                vision.setup('input-area', 'image-preview-container', 'input');

                // Ensure controls are unlocked even if init fails (partial functionality)
                ui.updateProgress(1.0, "Ready");

                // Fix: Copy Logs Button
                const copyBtn = document.getElementById('copy-logs-btn');
                if (copyBtn) {
                    copyBtn.onclick = () => {
                        const logs = document.getElementById('status-log').innerText;
                        navigator.clipboard.writeText(logs).then(() => ui.log("üìã Logs copied to clipboard", "success"));
                    };
                }

                document.getElementById('model-select').disabled = false;
                document.getElementById('load-model-btn').disabled = false;
                document.getElementById('load-model-btn').addEventListener('click', loadModel);

                // Input Handlers (idempotent)
                const sendBtn = document.getElementById('send-btn');
                const input = document.getElementById('input');

                if (sendBtn && input) {
                    sendBtn.onclick = handleSend; // Use property to avoid duplicates
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                            e.preventDefault();
                            handleSend();
                        }
                    };
                }
            }
        }

        // --- BRIDGE LOGIC ---
        let bridgeWs = null;
        
        // GPU Status Check and Force Unlock Handler
        async function checkGPUStatus() {
            try {
                const res = await fetch("http://localhost:8080/v1/gpu/status", {
                    method: "GET",
                    headers: { "Authorization": "Bearer sovereign-secret" }
                });

                if (res.ok) {
                    const status = await res.json();
                    ui.log(`GPU Status: ${status.locked ? `LOCKED by ${status.owner}` : 'FREE'}. Queue: ${status.queue_depth} items.`, "info");
                    if (status.queued && status.queued.length > 0) {
                        ui.log(`Queued: ${status.queued.join(', ')}`, "info");
                    }

                    // Check model loading status
                    const modelLoadStatus = GPUController.getModelLoadStatus();
                    if (modelLoadStatus.hasPendingLoad || modelLoadStatus.queueSize > 0) {
                        ui.log(`Model Load Status: Queue: ${modelLoadStatus.queueSize}, Active: ${modelLoadStatus.activeLoaders.join(', ')}`, "info");
                    }

                    return status;
                } else {
                    ui.log(`Status check failed: ${res.status}`, "warn");
                    return null;
                }
            } catch (e) {
                ui.log(`Status check error: ${e.message}`, "warn");
                return null;
            }
        }

        document.getElementById('debug-gpu-btn').addEventListener('click', async () => {
            await checkGPUStatus();
        });

        document.getElementById('force-unlock-btn').addEventListener('click', async () => {
            if (!confirm("‚ö†Ô∏è Force Unlock GPU?\nOnly do this if the system is stuck waiting for a lock.")) return;

            try {
                ui.log("Sending Force Unlock signal...", "warn");

                // First try the standard reset
                let res = await fetch("http://localhost:8080/v1/gpu/reset", {
                    method: "POST",
                    headers: { "Authorization": "Bearer sovereign-secret" }
                });

                if (res.ok) {
                    ui.log("üîì GPU Lock Force Released (Standard).", "success");
                } else {
                    ui.log(`Standard unlock failed: ${res.status}. Trying emergency release...`, "warn");

                    // If standard unlock failed, try the emergency endpoint
                    res = await fetch("http://localhost:8080/v1/gpu/force-release-all", {
                        method: "POST",
                        headers: { "Authorization": "Bearer sovereign-secret" }
                    });

                    if (res.ok) {
                        ui.log("üîì GPU Locks Force Released (Emergency).", "success");
                    } else {
                        ui.log(`Emergency unlock failed: ${res.status}`, "error");
                    }
                }
            } catch (e) {
                ui.log(`Unlock Error: ${e.message}`, "error");
            }
        });

        window.toggleBridge = function (enabled) {
            if (enabled) {
                if (!engine) { alert("Load model first!"); document.getElementById('enable-bridge-toggle').checked = false; return; }
                bridgeWs = new WebSocket("ws://localhost:8080/ws/chat");
                bridgeWs.onopen = () => { document.getElementById('bridge-status').innerText = "üü¢ Connected"; ui.log("Bridge Online", "success"); };
                // [Replace the existing bridgeWs.onmessage handler with this]
                bridgeWs.onmessage = async (e) => {
                    const msg = JSON.parse(e.data);
                    
                    // 1. STANDARD CHAT REQUEST (e.g. from VS Code)
                    if (msg.type === 'chat') {
                        ui.log(`Bridge Chat: ${msg.id}`, "info");
                        try {
                            const completion = await engine.chat.completions.create({ 
                                messages: msg.data.messages, 
                                stream: true 
                            });
                            for await (const chunk of completion) {
                                bridgeWs.send(JSON.stringify({ id: msg.id, chunk }));
                            }
                            bridgeWs.send(JSON.stringify({ id: msg.id, done: true }));
                        } catch (err) {
                            bridgeWs.send(JSON.stringify({ id: msg.id, error: err.message }));
                        }
                    } 
                    
                    // 2. MEMORY SEARCH REQUEST (From Chrome Extension)
                    else if (msg.type === 'memory_query') {
                        const queryText = msg.data.query;
                        ui.log(`üîé Bridge Memory Search: "${queryText}"`, "info");
                        try {
                            // Use the new decoupled method
                            const results = await contextManager.findRelevantMemories(queryText);
                            
                            // Send pure JSON back to the bridge
                            bridgeWs.send(JSON.stringify({ 
                                id: msg.id, 
                                result: results 
                            }));
                            ui.log(`‚úÖ Returned ${results.length} memories`, "success");
                        } catch (err) {
                            bridgeWs.send(JSON.stringify({ id: msg.id, error: err.message }));
                            ui.log(`‚ùå Search Failed: ${err.message}`, "error");
                        }
                    }
                };
            } else if (bridgeWs) { bridgeWs.close(); bridgeWs = null; document.getElementById('bridge-status').innerText = "Disconnected"; }
        };

        window.addEventListener('load', init);
    </script>
</body>

</html>