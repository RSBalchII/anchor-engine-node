<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Coda Console</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: #0f0f11;
            color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        /* --- Resizable Split Layout --- */
        #container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            /* Default width */
            min-width: 200px;
            max-width: 80%;
            background: #151517;
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            transition: width 0.1s ease;
        }

        /* Resize Handle */
        #resizer {
            width: 5px;
            cursor: col-resize;
            background: #333;
            transition: background 0.2s;
            z-index: 10;
        }

        #resizer:hover,
        #resizer.resizing {
            background: #00ff88;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            position: relative;
            min-width: 0;
        }

        /* --- Collapsible Details --- */
        details {
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        summary {
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            background: #252526;
            list-style: none;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '‚ñº';
            float: right;
            font-size: 0.8em;
            transition: transform 0.2s;
        }

        details[open] summary::after {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* --- Chat Box --- */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        #chat-box::-webkit-scrollbar {
            width: 8px;
        }

        #chat-box::-webkit-scrollbar-track {
            background: #333;
        }

        #chat-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .msg {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            background: #333;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user {
            background: #005f3b; /* Root Green-ish */
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .assistant {
            background: #2d2d2d;
            border-left: 3px solid #00ff88;
        }

        .msg details {
            margin-top: 10px;
            font-size: 0.85rem;
            opacity: 0.7;
            border: none;
        }

        .msg pre {
            background: #151515;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.8rem;
        }

        h3 {
            margin: 0 0 10px 0;
        }

        #status-text {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 8px;
        }

        #progress-bar {
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        #progress {
            height: 100%;
            background: #00ff88;
            width: 0%;
            transition: width 0.2s;
        }

        #status-log {
            flex: 1;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            margin-top: 10px;
            padding: 8px;
            background: #0f0f0f;
            border-radius: 4px;
            border: 1px solid #333;
        }

        #status-log div {
            margin: 2px 0;
            padding: 2px 0;
        }

        .info { color: #888; }
        .warn { color: #ffc107; }
        .error { color: #ff4444; }
        .success { color: #00ff88; }

        #input-area {
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            height: 60px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 10px;
            border-radius: 4px;
            resize: vertical;
            font-family: 'Segoe UI', sans-serif;
        }

        textarea:focus {
            outline: none;
            border-color: #00ff88;
        }

        button {
            padding: 8px 20px;
            background: #2d2d2d;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-end;
            transition: all 0.2s;
        }

        button:hover {
            border-color: #00ff88;
            color: #00ff88;
        }

        button:disabled {
            background: #222;
            border-color: #333;
            color: #555;
            cursor: not-allowed;
        }

        .streaming {
            border-right: 2px solid #00ff88;
            animation: blink 0.7s infinite;
        }

        @keyframes blink { 50% { border-color: transparent; } }
    </style>
</head>

<body>
    <div id="container">
        <div id="sidebar">
            <div style="padding: 10px; font-weight: bold; font-size: 16px; border-bottom: 1px solid #444; color: #00ff88;">
                ‚ö° ROOT CODA
            </div>
            <small id="status-text" style="padding: 0 10px;">Initializing...</small>
            <div id="progress-bar" style="margin: 8px 10px 15px 10px;">
                <div id="progress"></div>
            </div>

            <!-- COLLAPSIBLE: Model Selection -->
            <details open>
                <summary>Model Selection</summary>
                <div class="panel-content">
                    <label for="hw-profile" style="display:block; font-size: 11px; color: #ccc; margin-bottom: 4px;">Hardware Profile:</label>
                    <select id="hw-profile" class="form-control" style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555; margin-bottom: 10px;">
                        <option value="lite">üîã Lite (Mobile / Snapdragon) - 2k Context</option>
                        <option value="mid" selected>üíª Mid (8GB VRAM) - 4k Context</option>
                        <option value="high">üöÄ High (16GB VRAM) - 16k Context</option>
                        <option value="ultra">‚ö° Ultra (24GB+ VRAM) - 32k Context</option>
                    </select>
                    <select id="model-select" disabled style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555;">
                        <option value="" disabled selected>-- Select a Model --</option>
                        <optgroup label="Root Verified">
                            <option value="mlc-ai/Qwen2.5-1.5B-Instruct-q4f16_1-MLC">Qwen2.5-1.5B (Fastest)</option>
                            <option value="mlc-ai/Qwen2.5-3B-Instruct-q4f16_1-MLC">Qwen2.5-3B (Balanced)</option>
                            <option value="mlc-ai/Qwen2.5-7B-Instruct-q4f16_1-MLC">Qwen2.5-7B (Strong)</option>
                            <option value="mlc-ai/Qwen2.5-14B-Instruct-q4f16_1-MLC">Qwen2.5-14B (Powerful)</option>
                        </optgroup>
                        <optgroup label="DeepSeek / Reasoning">
                            <option value="mlc-ai/DeepSeek-R1-Distill-Qwen-1.5B-q4f16_1-MLC">DeepSeek-R1-Distill-1.5B</option>
                            <option value="mlc-ai/DeepSeek-R1-Distill-Qwen-7B-q4f16_1-MLC">DeepSeek-R1-Distill-7B</option>
                            <option value="mlc-ai/DeepSeek-R1-Distill-Qwen-14B-q4f16_1-MLC">DeepSeek-R1-Distill-14B</option>
                        </optgroup>
                        <optgroup label="Llama / Mistral">
                            <option value="mlc-ai/Llama-3.2-3B-Instruct-q4f16_1-MLC">Llama-3.2-3B</option>
                            <option value="mlc-ai/Mistral-7B-Instruct-v0.2-q4f16_1-MLC">Mistral-7B</option>
                        </optgroup>
                        <option value="custom">-- Custom --</option>
                    </select>
                    <input id="custom-model-input" type="text" placeholder="Custom model ID" style="width: 100%; padding: 5px; font-size: 11px;" disabled />
                    <button id="load-model-btn" disabled style="width: 100%; padding: 6px; margin-top:5px; font-size: 11px;">Load Model</button>
                </div>
            </details>

            <!-- COLLAPSIBLE: Controls -->
            <details>
                <summary>System Controls</summary>
                <div class="panel-content">
                    <div style="background: #222; padding: 4px; margin-bottom: 4px; border: 1px solid #444; border-radius: 4px;">
                        <input type="checkbox" id="enable-bridge-toggle" onchange="toggleBridge(this.checked)">
                        <label for="enable-bridge-toggle" style="font-size: 11px; cursor: pointer;">Enable Wave Bridge (ws:8080)</label>
                        <div id="bridge-status" style="font-size: 10px; color: #666; margin-left: 20px;">Disconnected</div>
                    </div>
                    <button id="clear-cache-btn" style="width: 100%; padding: 6px; background: #a43131; border:none; margin-top:5px; font-size: 11px;">‚ö†Ô∏è Delete Model Cache</button>
                    <button id="debug-gpu-btn" style="width: 100%; padding: 6px; background: #555; border:none; margin-top: 5px; font-size: 11px;">‚ùì Debug GPU</button>
                </div>
            </details>

            <!-- COLLAPSIBLE: Logs -->
            <details open style="flex: 1; display: flex; flex-direction: column;">
                <summary>System Logs</summary>
                <div class="panel-content" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <button id="copy-logs-btn" style="width: 100%; padding: 4px; background: #333; font-size: 10px;">üìã Copy Logs</button>
                    <div id="status-log"></div>
                </div>
            </details>
        </div>

        <div id="resizer"></div>

        <div id="main">
            <!-- Split view for Chat and Context -->
            <div style="flex: 1; display: flex; height: 100%; overflow: hidden;">
                <!-- Chat Column -->
                <div style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid #333;">
                    <div style="padding: 10px; background: #252526; font-weight: bold; border-bottom: 1px solid #333;">üí¨ Chat Stream</div>
                    <div id="chat-box"></div>
                    <div id="input-area" style="padding: 10px; border-top: 1px solid #333;">
                        <textarea id="input" disabled placeholder="Waiting for Engine..."></textarea>
                        <button id="send-btn" disabled>Send</button>
                    </div>
                </div>

                <!-- Context Column -->
                <div style="width: 40%; display: flex; flex-direction: column; background: #151515;">
                    <div style="padding: 10px; background: #252526; font-weight: bold; border-bottom: 1px solid #333;">üß† Root Memory</div>
                    <div id="context-box" style="flex: 1; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; color: #aaa;">
                        <div style="text-align: center; margin-top: 50px; color: #555;">(Active retrievals will appear here)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
        import { SovereignLogger, createStore, getWebGPUConfig, initCozo } from './modules/sovereign.js';
        import { CozoDb } from './cozo_lib_wasm.js'; 
        import { loadAllFromIndexedDb, writeToIndexedDb } from './indexeddb.js';
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

        env.allowLocalModels = false;

        // --- ROOT KERNEL SETUP ---
        const logger = new SovereignLogger('Root-Console');
        
        const { state, subscribe } = createStore({
            status: "Initializing...",
            progress: 0,
            activeModel: null
        });

        // Bridge legacy UI logging to Sovereign Logger
        const ui = {
            log: (msg, type = 'info') => {
                // Bridge to Kernel Logger
                if (type === 'debug') type = 'info'; 
                if (logger[type]) logger[type](msg); else logger.info(msg);

                // Update on-screen log
                const el = document.getElementById('status-log');
                if(el) {
                    const div = document.createElement('div');
                    div.className = type;
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    div.style.fontSize = '11px'; 
                    div.style.padding = '2px';
                    div.style.borderBottom = '1px solid #222';
                    el.insertBefore(div, el.firstChild);
                    if (el.children.length > 100) el.removeChild(el.lastChild);
                }
            },
            updateProgress: (pct, text) => {
                const bar = document.getElementById('progress');
                if(bar) bar.style.width = (pct * 100) + "%";
                if (text) {
                    const el = document.getElementById('status-text');
                    if(el) el.innerText = text;
                }
            },
            append: (role, text, meta = null) => {
                const box = document.getElementById('chat-box');
                const div = document.createElement('div');
                div.className = `msg ${role}`;
                div.innerHTML = text ? marked.parse(text) : "";

                if (meta && meta.trace && meta.trace.length > 0) {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    summary.textContent = 'üìã Reasoning Trace';
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(meta.trace, null, 2);
                    details.appendChild(summary);
                    details.appendChild(pre);
                    div.appendChild(details);
                }

                box.appendChild(div);
                box.scrollTop = box.scrollHeight;

                return {
                    div,
                    update: (newText, isMarkdown = true) => {
                        div.innerHTML = isMarkdown ? marked.parse(newText) : newText;
                        box.scrollTop = box.scrollHeight;
                    },
                    appendText: (chunk) => {
                        if (div.innerText.endsWith("...")) div.innerText = div.innerText.slice(0, -3);
                        div.innerText += chunk;
                        box.scrollTop = box.scrollHeight;
                    }
                };
            },
            appendContext: (title, details) => {
                const box = document.getElementById('context-box');
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #333';
                div.style.marginBottom = '10px';
                div.style.paddingBottom = '10px';

                const h4 = document.createElement('div');
                h4.style.fontWeight = 'bold';
                h4.style.color = '#00ff88';
                h4.style.marginBottom = '5px';
                h4.textContent = `[${new Date().toLocaleTimeString()}] ${title}`;

                const p = document.createElement('div');
                p.style.whiteSpace = 'pre-wrap';
                p.textContent = details;

                div.appendChild(h4);
                div.appendChild(p);
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        // --- GLOBAL STATE ---
        let db;
        let embedder;
        let engine;
        let contextManager;
        let selectedModelId = null;

        // --- UTILS: Response Pattern Matcher ---
        class ResponsePattern {
            static match(response) {
                let data = response;
                if (typeof response === 'string') {
                    try {
                        const clean = response.replace(/```json/g, '').replace(/```/g, '').trim();
                        if (clean.startsWith('{')) data = JSON.parse(clean);
                    } catch (e) { }
                }
                if (data?.rows && Array.isArray(data.rows)) return { type: 'DB_RESULT', rows: data.rows, count: data.rows.length };
                if (data?.error || (typeof response === 'string' && response.toLowerCase().includes('error:'))) return { type: 'ERROR', error: data?.error || response };
                if (data?.ok === false && data?.message) return { type: 'ERROR', error: data.message };
                return { type: 'RAW_TEXT', text: typeof response === 'string' ? response : JSON.stringify(response) };
            }
        }

        // --- LOGIC: Context Manager (SFS) ---
        class ContextManager {
            constructor(engine, db) {
                this.engine = engine;
                this.db = db;
                this.maxIterations = 3;
            }

            async retrieveInitialContext(userText) {
                ui.log("üîç Reflex: Scanning for keywords...", "info");
                const rawWords = userText.match(/[a-zA-Z0-9_\-]+/g) || [];
                const stopWords = new Set(['the', 'and', 'is', 'in', 'at', 'of', 'on', 'for', 'to', 'it', 'this', 'that', 'with', 'what', 'who', 'how', 'why', 'when', 'where', 'did', 'does', 'do', 'can', 'could', 'would', 'should', 'will', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'a', 'an']);
                const keywords = rawWords.map(w => w.replace(/^[-_]+|[-_]+$/g, '')).filter(w => w.length > 2 && !stopWords.has(w.toLowerCase()));

                if (keywords.length === 0) return "";
                ui.log(`Reflex Keywords: [${keywords.join(', ')}]`, "info");

                const conditions = keywords.map(w => `regex_matches(content, '(?i)${w}')`).join(' or ');
                const query = `?[id, content, timestamp] := *memory{id, content, timestamp}, ${conditions} :sort -timestamp :limit 10`;

                try {
                    const result = await this.db.run(query, "{}");
                    const parsed = ResponsePattern.match(result);

                    if (!parsed || parsed.error) return "";
                    if (parsed.rows && Array.isArray(parsed.rows) && parsed.rows.length > 0) {
                        ui.log(`‚úÖ Reflex found ${parsed.rows.length} matches.`, "success");
                        const items = parsed.rows.slice(0, 10);
                        const paths = [];
                        const clues = items.map((row, index) => {
                            const id = index + 1;
                            const rawContent = row[1];
                            const timestamp = row[2] || "Unknown Date";
                            let title = "doc_" + id;
                            if (rawContent && rawContent.length > 0) {
                                const safeTitle = rawContent.substring(0, 30).replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '_').toLowerCase();
                                if (safeTitle.length > 3) title = safeTitle;
                            }
                            const path = `/knowledge/general/${title}`;
                            paths.push(path);
                            let snippet = rawContent.substring(0, 250).replace(/\n/g, ' ');
                            if (rawContent.length > 250) snippet += "...";
                            return `[CLUE #${id}] [Path: ${path}] [Date: ${timestamp}]\nSnippet: "${snippet}"`;
                        });

                        const treeMap = `[CURRENT REALITY MAP]\n` + paths.map(p => `- ${p}`).join('\n');
                        return `${treeMap}\n\n[CONTEXT CLUES]\n${clues.join('\n\n')}`;
                    }
                } catch (e) {
                    ui.log(`Reflex Crash: ${e.message}`, "error");
                }
                return "";
            }

            buildVirtualPrompt(systemPrompt, retrievedMemories, chatHistory, userText) {
                const physicsInstruction = `
### COGNITIVE PROTOCOL:
1. **TRUST THE CLUES:** You are operating in a "Sovereign" environment. The [CONTEXT CLUES] provided are the Ground Truth.
2. **MINIMIZE ENTROPY:** If a Clue contains the answer, OUTPUT IT DIRECTLY. Do not generate "filler".
3. **PATH OF LEAST ACTION:** The most efficient answer is the correct one.
`;
                return `
### BACKGROUND INFORMATION
${retrievedMemories ? retrievedMemories : "No specific context available."} 

### CHAT HISTORY
${chatHistory.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n')}

### INSTRUCTION
${systemPrompt}
${physicsInstruction}
Based on the Background Information above, answer the following question.

### USER QUESTION
${userText}
`;
            }

            async executeR1Loop(userText, history) {
                let iteration = 0;
                let currentContext = await this.retrieveInitialContext(userText);
                if (currentContext) ui.appendContext("Reflex Retrieval", currentContext);

                while (iteration < this.maxIterations) {
                    iteration++;
                    const fullPrompt = this.buildVirtualPrompt(
                        "You are Root Coda, a Sovereign Agent.\n" +
                        "PROTOCOL: Trust clues. Answer directly. No refusals.",
                        currentContext,
                        history.slice(-5),
                        userText
                    );

                    ui.log(`üß† Reasoning (Iter ${iteration})...`, "info");
                    let reply = "";
                    try {
                        const response = await this.engine.chat.completions.create({
                            messages: [{ role: "user", content: fullPrompt }],
                            temperature: 0.1,
                            max_tokens: 100
                        });
                        reply = response.choices[0].message.content.trim();
                    } catch (genErr) {
                         if (genErr.message.includes("disposed")) return { context: currentContext, finalAnswer: "‚ö†Ô∏è System Crash: GPU Driver lost." };
                         throw genErr;
                    }

                    if (reply.includes("NEED_CONTEXT:")) {
                        const searchTerm = reply.split("NEED_CONTEXT:")[1].trim();
                        ui.log(`ü§ñ Requested search: "${searchTerm}"`, "warn");
                        const extraData = await this.retrieveInitialContext(searchTerm);
                        if (extraData) {
                            currentContext += `\n--- Additional (${searchTerm}) ---\n${extraData}`;
                            ui.appendContext(`Requested: ${searchTerm}`, extraData);
                        }
                        continue; 
                    }
                    return { context: currentContext, finalAnswer: reply };
                }
                return { context: currentContext, finalAnswer: null };
            }
        }

        // --- HANDLERS ---
        async function handleSend() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text || !engine) return;

            input.value = "";
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            ui.append("user", text);

            try {
                const { context, finalAnswer } = await contextManager.executeR1Loop(text, []);
                if (finalAnswer && finalAnswer.includes("System Crash")) return ui.log("üõë Execution halted (GPU Crash).", "error");

                ui.log("üß™ Synthesizing...", "warn");
                const sysPrompt = `You are a helpful assistant with access to retrieved context. Use it to answer the user's question.\n\nCONTEXT:\n${context || "(No relevant context)"}`;
                const msgHandle = ui.append("assistant", "");

                const stream = await engine.chat.completions.create({
                    messages: [ { role: "system", content: sysPrompt }, { role: "user", content: text } ],
                    max_tokens: 1024,
                    temperature: 0.7,
                    stream: true
                });

                let fullAnswer = "";
                for await (const chunk of stream) {
                    const delta = chunk.choices[0]?.delta?.content || "";
                    fullAnswer += delta;
                    msgHandle.update(fullAnswer);
                }
                ui.log("‚úÖ Response generated.", "success");

            } catch (e) {
                ui.log(`Error: ${e.message}`, "error");
                ui.append("assistant", `**Error:** ${e.message}`);
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        async function loadModel() {
            const select = document.getElementById('model-select');
            const customInput = document.getElementById('custom-model-input');
            const modelInput = select.value === 'custom' ? customInput.value : select.value;
            if (!modelInput) return alert("Please select a model.");

            selectedModelId = modelInput.split('/').pop();
            document.getElementById('load-model-btn').disabled = true;

            try {
                ui.log(`Initializing Engine (${selectedModelId})...`, "info");
                
                // --- KERNEL: Hardware Config ---
                const hwProfile = document.getElementById('hw-profile').value;
                const gpuConfig = await getWebGPUConfig(hwProfile);
                
                if (gpuConfig.isConstrained) {
                     ui.log(`‚ö†Ô∏è Clamping WebGPU buffer to ${Math.round(gpuConfig.maxBufferSize/1024/1024)}MB`, "warn");
                } else {
                     ui.log(`‚úÖ GPU Configured: ${Math.round(gpuConfig.maxBufferSize/1024/1024)}MB Buffer`, "success");
                }

                // --- Config Generation ---
                // (Simplified Logic for cleaner file)
                const libBase = "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0_2_80/";
                let modelLib = null;
                const lowerId = selectedModelId.toLowerCase();
                let qTag = "q4f16_1"; // Default
                
                // Mapper
                if (lowerId.includes('llama-3.2-3b')) modelLib = libBase + `Llama-3.2-3B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                else if (lowerId.includes('qwen2.5-1.5b')) modelLib = libBase + `Qwen2-1.5B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                else if (lowerId.includes('qwen2.5-3b')) modelLib = libBase + `Qwen2.5-3B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                else if (lowerId.includes('qwen2.5-7b')) modelLib = libBase + `Qwen2-7B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                else if (lowerId.includes('qwen2.5-14b')) modelLib = libBase + `Qwen2.5-14B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`;
                
                if (!modelLib) modelLib = libBase + `Qwen2-7B-Instruct-${qTag}-ctx4k_cs1k-webgpu.wasm`; // Fallback

                let appConfig = {
                    useIndexedDBCache: true,
                    model_list: [{
                        model: "https://huggingface.co/" + modelInput + "/resolve/main/",
                        model_id: selectedModelId,
                        model_lib: modelLib,
                        vram_required_MB: 2000, 
                        low_resource_required: true,
                        buffer_size_required_bytes: gpuConfig.maxBufferSize,
                    }]
                };
                
                // Create Device
                const device = await gpuConfig.adapter.requestDevice(gpuConfig.deviceConfig);
                
                engine = await webllm.CreateMLCEngine(selectedModelId, {
                    appConfig,
                    device, // KERNEL FIX
                    initProgressCallback: (rep) => ui.updateProgress(rep.progress, rep.text)
                });

                ui.log("üéâ Root Console Online", "success");
                contextManager = new ContextManager(engine, db);
                document.getElementById('input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('input').focus();
                
            } catch (e) {
                ui.log(`Load Failed: ${e.message}`, "error");
                document.getElementById('load-model-btn').disabled = false;
            }
        }

        async function init() {
            try {
                ui.log("üöÄ Root Kernel Starting...", "info");
                
                // 1. CozoDB
                await initCozo('./cozo_lib_wasm_bg.wasm');
                // Recovery Logic
                try {
                     const [keys] = await loadAllFromIndexedDb('coda_memory', 'cozo_store', () => {});
                     if (keys.length > 0) {
                         db = await CozoDb.new_from_indexed_db('coda_memory', 'cozo_store', () => {});
                         ui.log("‚úÖ Root Graph Connected (Persistent)", "success");
                     } else {
                         db = CozoDb.new(); 
                         ui.log("‚úÖ Root Graph Created (Memory)", "info");
                     }
                } catch(e) {
                    db = CozoDb.new();
                    ui.log("‚ö†Ô∏è Fallback to Memory Graph", "warn");
                }

                // 2. Embedder (Optional)
                ui.updateProgress(0.3, "Loading Embedder...");
                const embedderPromise = pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { device: 'wasm' });
                try {
                    embedder = await Promise.race([embedderPromise, new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 10000))]);
                    ui.log("‚úÖ Neural Embedder Ready", "success");
                } catch(e) { ui.log("‚ö†Ô∏è Embedder Skipped (Timeout)", "warn"); }

                ui.updateProgress(1.0, "Ready");
                document.getElementById('model-select').disabled = false;
                document.getElementById('load-model-btn').disabled = false;
                document.getElementById('load-model-btn').addEventListener('click', loadModel);
                
                // Input Handlers
                document.getElementById('send-btn').addEventListener('click', handleSend);
                document.getElementById('input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey && !document.getElementById('send-btn').disabled) {
                        e.preventDefault();
                        handleSend();
                    }
                });
                
                // Bridge logic...
                document.getElementById('copy-logs-btn').addEventListener('click', () => {
                     navigator.clipboard.writeText(document.getElementById('status-log').innerText);
                });

            } catch(e) {
                ui.log(`Init Error: ${e.message}`, "error");
            }
        }
        
        // --- BRIDGE LOGIC ---
        let bridgeWs = null;
        window.toggleBridge = function(enabled) {
            if (enabled) {
                if(!engine) { alert("Load model first!"); document.getElementById('enable-bridge-toggle').checked=false; return; }
                bridgeWs = new WebSocket("ws://localhost:8080/ws/chat");
                bridgeWs.onopen = () => { document.getElementById('bridge-status').innerText = "üü¢ Connected"; ui.log("Bridge Online", "success"); };
                bridgeWs.onmessage = async (e) => {
                    const msg = JSON.parse(e.data);
                    if(msg.type === 'chat') {
                         ui.log(`Bridge Request: ${msg.id}`, "info");
                         const completion = await engine.chat.completions.create({ messages: msg.data.messages, stream: true });
                         for await (const chunk of completion) bridgeWs.send(JSON.stringify({id: msg.id, chunk}));
                         bridgeWs.send(JSON.stringify({id: msg.id, done: true}));
                    }
                };
            } else if(bridgeWs) { bridgeWs.close(); bridgeWs=null; document.getElementById('bridge-status').innerText = "Disconnected"; }
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>
